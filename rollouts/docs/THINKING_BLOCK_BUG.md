# Thinking Block Resume Bug Investigation

## The Crash

When resuming a session with extended thinking enabled, the Anthropic API returns:
```
400 - "messages.5.content.3: thinking or redacted_thinking blocks in the
latest assistant message cannot be modified. These blocks must remain as
they were in the original response."
```

Session: `20251223_152205_b0fba6`
Crash file: `~/.rollouts/crashes/20251223_155514_ca6d0a.txt`

## Known Issue

This is a known bug affecting Claude Code as well:
- https://github.com/anthropics/claude-code/issues/12316
- https://github.com/anthropics/claude-code/issues/12130
- https://github.com/anthropics/claude-code/issues/12311

## Anthropic API Requirements

From [Anthropic's documentation](https://platform.claude.com/docs/en/build-with-claude/extended-thinking):

1. **Thinking blocks must be unmodified**: "The entire sequence of consecutive `thinking` blocks must match the outputs generated by the model during the original request; you cannot rearrange or modify the sequence of these blocks."

2. **Signature must be preserved**: The `signature` field exists for verification and must be included exactly as received.

3. **Last assistant message rule**: "You must pass `thinking` blocks back to the API for the last assistant message. Include the complete unmodified block back to the API to maintain reasoning continuity."

## Root Cause Analysis

Investigation of the crashed session revealed:

### 1. Consecutive Same-Role Messages
The session had consecutive assistant messages at indices 12-13, 15-16, etc:
```
12: assistant - text
13: assistant - [thinking, text, tool_use]  ‚Üê HAS THINKING
```

The Anthropic API expects alternating user/assistant roles. When we send consecutive same-role messages, the API may merge them or interpret the thinking blocks as modified.

### 2. Orphaned Tool Calls
The session had patterns where tool calls weren't followed by tool results before the next assistant message. This violates the expected message flow.

### 3. Thinking Signatures ARE Preserved
Our serialization correctly preserves `thinking_signature` through JSON round-trip. The issue is not serialization corruption.

## How pi-mono Handles This

Reference: `/tmp/pi-mono/packages/ai/src/providers/transorm-messages.ts`

1. **Insert synthetic tool results** (lines 88-104): When an assistant message follows orphaned tool calls, insert synthetic `tool_result` messages:
```typescript
result.push({
    role: "toolResult",
    toolCallId: tc.id,
    toolName: tc.name,
    content: [{ type: "text", text: "No result provided" }],
    isError: true,
    timestamp: Date.now(),
});
```

2. **Handle user interrupts** (lines 118-135): When a user message interrupts a tool flow, also insert synthetic results.

3. **Cross-provider thinking handling** (lines 49-54): When switching providers, convert thinking blocks to text:
```typescript
if (block.type === "thinking") {
    return {
        type: "text" as const,
        text: `<thinking>\n${block.thinking}\n</thinking>`,
    };
}
```

## Proposed Fix

1. **Merge consecutive same-role messages** before sending to Anthropic API, preserving all content blocks in order.

2. **Insert synthetic tool results** for orphaned tool calls (following pi-mono's approach).

3. **Strip thinking blocks from non-last assistant messages** OR ensure they remain perfectly unmodified.

## Test Coverage

Added `tests/test_thinking_block_resume.py` with:
- `test_thinking_signature_preserved_in_serialize_deserialize`: Verifies JSON round-trip
- `test_message_to_anthropic_includes_signature`: Verifies API format conversion
- `test_message_to_anthropic_converts_missing_signature_to_text`: Handles aborted streams
- `test_resume_session_preserves_all_thinking_blocks`: Multi-message scenario
- `test_consecutive_assistant_messages_both_preserved`: Edge case handling
- `test_real_api_thinking_block_round_trip`: Integration test with real API

## The Fix

**Two-part solution** (matching pi-mono's approach):

### 1. Insert synthetic tool results (transform_messages.py)

When consecutive assistant messages exist (which can happen when user interrupts
during tool execution), insert synthetic `[interrupted - no result provided]`
tool results to break up the consecutive pattern.

```python
def _insert_synthetic_tool_results(messages):
    # Before: [assistant w/tool_use] -> [assistant w/tool_use] -> [user]
    # After:  [assistant w/tool_use] -> [tool: interrupted] -> [assistant w/tool_use] -> [user]
```

This prevents Anthropic's server-side merge which corrupts thinking block validation.

### 2. Add interrupted results on cancel (agents.py)

When the agent is cancelled (e.g., user presses Escape), check both
`pending_tool_calls` AND the last message's tool calls to ensure all
tool_use blocks get corresponding `[interrupted]` tool results.

```python
# Check both pending_tool_calls AND the last message's tool calls.
# If cancelled during rollout(), pending_tool_calls may be empty but
# the assistant message with tool calls is already in the trajectory.
```

## How the bug happens

1. User sends message
2. Assistant responds with [thinking, tool_use]
3. User presses Escape while tool is executing
4. New LLM call happens (another [thinking, tool_use])
5. First tool call never got a result
6. Session saved with consecutive assistant messages
7. On resume, API merges them and rejects "thinking blocks modified"

## Verification

Test passes with the exact crashed session:
```bash
python -m pytest tests/test_thinking_block_resume.py -v
```
